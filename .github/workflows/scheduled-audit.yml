name: ðŸ“… Scheduled DGuard Audit

on:
  schedule:
    # Ejecutar todos los dÃ­as laborales a las 9 AM UTC
    - cron: '0 9 * * 1-5'
  workflow_dispatch:

env:
  BACKEND_REPO: 'ai-sapira/DGuardAPI'
  FRONTEND_REPO: 'ai-sapira/DGuard'
  PHISHING_API_REPO: 'ai-sapira/DGuard-Phishing-API'
  URL_CHECKER_REPO: 'ai-sapira/DGuard-URL-Checker'

jobs:
  scheduled-audit:
    name: AuditorÃ­a Programada
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Audit Bot
      uses: actions/checkout@v4
    
    - name: ðŸ“¥ Checkout Repositories
      run: |
        # Clonar repositorios DGuard usando GitHub CLI
        gh repo clone ${{ env.BACKEND_REPO }} projects/backend
        gh repo clone ${{ env.FRONTEND_REPO }} projects/frontend
        gh repo clone ${{ env.PHISHING_API_REPO }} projects/phishing-api || echo "Phishing API repo not available"
        gh repo clone ${{ env.URL_CHECKER_REPO }} projects/url-checker || echo "URL Checker repo not available"
      env:
        GH_TOKEN: ${{ secrets.GH_PAT || github.token }}
    
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ðŸ“¦ Install Dependencies
      run: npm ci
    
    - name: ðŸ¤– Execute Scheduled Audit
      run: |
        npm run audit -- \
          --backend ./projects/backend \
          --frontend ./projects/frontend \
          --additional ./projects/phishing-api \
          --additional ./projects/url-checker \
          --format all \
          --quiet
    
    - name: ðŸ“Š Generate Weekly Report
      if: github.event.schedule && contains(github.event.schedule, '1')  # Monday
      run: |
        echo "# ðŸ“Š Weekly DGuard Audit Report" > weekly-report.md
        echo "" >> weekly-report.md
        echo "**Week of:** $(date +'%B %d, %Y')" >> weekly-report.md
        echo "" >> weekly-report.md
        
        # Add summary from current report
        if [ -f reports/audit-report.json ]; then
          echo "## Current Status" >> weekly-report.md
          echo "" >> weekly-report.md
          
          CRITICAL=$(jq -r '.summary.issues.critical // 0' reports/audit-report.json)
          HIGH=$(jq -r '.summary.issues.high // 0' reports/audit-report.json)
          TOTAL=$(jq -r '.summary.issues.total // 0' reports/audit-report.json)
          
          echo "- **Critical Issues:** $CRITICAL" >> weekly-report.md
          echo "- **High Priority Issues:** $HIGH" >> weekly-report.md
          echo "- **Total Issues:** $TOTAL" >> weekly-report.md
          echo "" >> weekly-report.md
          
          if [ "$CRITICAL" -gt 0 ]; then
            echo "### âš ï¸ Action Required" >> weekly-report.md
            echo "Critical issues detected that need immediate attention." >> weekly-report.md
          elif [ "$HIGH" -gt 0 ]; then
            echo "### ðŸ“ Attention Needed" >> weekly-report.md
            echo "High priority issues should be addressed this week." >> weekly-report.md
          else
            echo "### âœ… All Good" >> weekly-report.md
            echo "No critical or high priority issues detected." >> weekly-report.md
          fi
        fi
    
    - name: ðŸ“§ Send Email Report
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ðŸ“Š DGuard Audit Report - $(date +'%Y-%m-%d')"
        to: team@dguard.com
        from: DGuard Audit Bot <noreply@dguard.com>
        body: |
          DGuard Audit completed successfully.
          
          Check the attached reports for detailed results.
          
          View full report: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        attachments: reports/audit-report.html,reports/audit-report.json
      continue-on-error: true
    
    - name: ðŸ’¾ Archive Reports
      uses: actions/upload-artifact@v4
      with:
        name: scheduled-audit-${{ github.run_number }}
        path: reports/
        retention-days: 90